<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="http://yandex.st/highlightjs/8.0/styles/zenburn.min.css">
    <link rel="stylesheet" type="text/css" href="../css/stylesheet.css" media="screen"/>
    <link rel="stylesheet" type="text/css" href="../css/pygment_trac.css" media="screen"/>
    <link rel="stylesheet" type="text/css" href="../css/app.css" media="screen"/>

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>Multi-player Labyrinth sample with Chromecast</title>
</head>

<body>
<header>
    <div class="inner">
        <h1>Multi-player Labyrinth sample</h1>

        <h2>with Chromecast</h2>
        <a target="_blank" href="https://github.com/xebia-france/workshop-cast-maze" class="button">
            <small>View project on</small>
            GitHub</a>
    </div>
</header>

<div id="content-wrapper">
    <div class="inner clearfix">
        <section id="main-content">
            <h2>Outils</h2>

<p>Google Cast API Reference : <a href="https://developers.google.com/cast/docs/reference/">docs</a></p>

<h2>Setup</h2>

<p>Depuis Chrome, téléchargez l&#39;extension <a href="https://chrome.google.com/webstore/detail/google-cast/boadgeojelhgndaghljhdicfkmllpafd">Google Chromecast</a>.</p>

<p>Clonez le dépôt :</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text"> $ git clone https://github.com/xebia-france/workshop-cast-maze.git
</code></pre></div>
<h2>Coding party</h2>

<p>Ouvrez le fichier suivant dans votre IDE favori</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">sender/js/app.js
</code></pre></div>
<p>Ce fichier contiendra tout le code nécessaire pour communiquer avec le serveur sur le chromecast.</p>

<h3>Configuration</h3>

<p>Renseignez l&#39;identifiant de l&#39;application dans la variable <code>appId</code></p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">var applicationID = &#39;8D7FEAA1&#39;;
</code></pre></div>
<p>Pour communiquer avec le chromecast (échanger des messages), un namespace est nécessaire,
renseigner le namespace de l&#39;application dans la variable <code>namespace</code></p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">var namespace = &#39;urn:x-cast:fr.xebia.workshop.cast.maze&#39;;
</code></pre></div>
<h3>Initialisation</h3>

<p>Ajouter l&#39;API Chromecast à la page <code>index.html</code></p>
<div class="highlight"><pre><code class="text language-text" data-lang="text"> &lt;script type=&quot;text/javascript&quot; src=&quot;https://www.gstatic.com/cv/js/sender/v1/cast_sender.js&quot;&gt;&lt;/script&gt;
</code></pre></div>
<p>Ecoutez l&#39;événement <code>__onGCastApiAvailable</code> cf. <a href="https://developers.google.com/cast/docs/chrome_sender#Initialization">Initialization</a>,
cet événement necessite un callback prenant deux paramètres,
 si le premier paramètre est <code>true</code> alors exécutez la méthode</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text"> initializeCastApi()
</code></pre></div>
<p>Sinon affichez une erreur.</p>

<p>La méthode <code>initializeCastApi()</code> permet d&#39;initialiser l&#39;API cf. <a href="https://developers.google.com/cast/docs/chrome_sender#Initialization">Initialization</a></p>

<p>Une fois le sender initialisé, la méthode <code>receiverListener(e)</code> permet de
connaître l&#39;état de la chromecast cf. <a href="https://developers.google.com/cast/docs/chrome_sender#Device_selection">Device Selection</a>.</p>

<p>La méthode <code>sessionListener(e)</code> est appelée quand la session existe déjà côté receiver et que celle-ci est renvoyée au sender.
Elle permet de sauvegarder la session dans le cas ou le receiver connais déjà le sender (join).</p>

<p>Lancer le serveur NodeJS (racine du projet) :</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">$ npm install
$ node server.js
</code></pre></div>
<p>Affichez la page web :</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">http://localhost:8080/sender/js/index.html
</code></pre></div>
<p>La page web s&#39;affiche correctement et vous devriez voir le message :</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">Chromecast available
Init success
</code></pre></div>
<h3>Connection au chromecast</h3>

<p>Codez la fonction <code>launchApp()</code> pour connecter
votre navigateur au chromecast cf. <a href="https://developers.google.com/cast/docs/chrome_sender#Launch">Launch</a></p>

<p>Affichez un message lorsque le navigateur est connecté cf. méthode <code>onRequestSessionSuccess(e)</code></p>

<p>Sauvegardez la session dans la méthode <code>onRequestSessionSuccess</code> de la même façon que dans la méthode <code>sessionListener</code></p>

<p>Retournez sur la page web :</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">http://localhost:8080/sender/js/index.html
</code></pre></div>
<p>Et vérifiez qu&#39;en cliquant sur le bouton <code>Launch app</code> un nouveau joueur apparait bien sur
 l&#39;écran connecté au chromecast.</p>

<p>La page web s&#39;affiche correctement et vous devriez voir le message :</p>

<p><img src="../img/session_requested.png" alt="Join messages"></p>

<p>Félicitation la connection au chromecast est réussie ! Allons
jouer maintenant :)</p>

<p>Si vous rafraîchissez votre navigateur vous n&#39;allez pas demander une nouvelle session mais vous allez vous connecter automatiquement et voir apparaître les messages :</p>

<p><img src="../img/session_join.png" alt="Join messages"></p>

<h3>Communiquer avec le chromecast</h3>

<p>Lorsque vous cliquez sur les boutons up, down, left, right la méthode <code>go(dir)</code> est appelée.</p>

<p>Faites en sorte d&#39;envoyer un message au chromecast cf. <a href="https://developers.google.com/cast/docs/reference/chrome/chrome.cast.Session#sendMessage">session.sendMessage</a></p>

<p>L&#39;application sur le chromecast n&#39;accepte que les messages :</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">up
down
right
left
</code></pre></div>
<p>Faites bouger votre joueur.</p>

<p>Félicitation ! Le joueur bouge ! Finissez le labyrinthe au plus vite :).</p>

<h3>Récupérer la couleur du joueur côté client</h3>

<p>Le chromecast peut aussi communiquer avec ses clients en utilisant des messages.</p>

<p>Pour cela il faut s&#39;abonner a session à un <code>listener</code> cf. <a href="https://developers.google.com/cast/docs/reference/chrome/chrome.cast.Session#addMessageListener">addMessageListener</a></p>

<p>Attention, vous devez gérer le cas ou vous demandez une session et le cas ou vous avez déjà une session.</p>

<p>Essayez de récupérer la couleur du joueur après la demande de session <code>onRequestSessionSuccess</code> et après le join <code>sessionListener</code>:</p>

<p>Cela se passe dans la méthode <code>onReceiverMessage(e)</code>, coder la conversion du paramètre en JSON et la vérification de l&#39;existence du champ <code>color</code></p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">e.color
</code></pre></div>
<p>Changez la couleur du fond par celle reçue :</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">document.body.style.backgroundColor = obj.color;
</code></pre></div>
<p>Déconnectez-vous puis reconnectez-vous à nouveau, vérifiez que la couleur du fond a bien changé.</p>

<p>Bravo ! Vous avez réussi à recevoir des messages depuis le chromecast :).</p>

<h3>Go</h3>

<p>Essayez de finir le labyrinthe !</p>

<h2>Next ?</h2>

<p>Codez une autre partie <a href="../index.html">receiver ou sender</a></p>

        </section>
        <aside id="sidebar">
            <a href="https://github.com/xebia-france/workshop-cast-maze/archive/master.zip" class="button">
                <small>Download</small>
                .zip file
            </a>
            <a href="https://github.com/xebia-france/workshop-cast-maze/archive/master.tar.gz" class="button">
                <small>Download</small>
                .tar.gz file
            </a>

            <p class="repo-owner"><a href="https://github.com/xebia-france/workshop-cast-maze">architect-theme</a> is
                maintained by <a href="https://github.com/xebia-france">xebia-france</a>.</p>

            <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the Architect theme
                by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>

            <p>Project initialized by <br/>
                Thomas G <a href="https://twitter.com/Tom404_">@Tom404_</a><br/>
                Jean-Christophe P<br/>
                Benjamin L <a href="https://twitter.com/benjlacroix">@benjlacroix</a></p>
        </aside>
    </div>
</div>
<script src="http://yandex.st/highlightjs/8.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
